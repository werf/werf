---
title: Базовые определения
sidebar: doc_sidebar
permalink: definitions.html
folder: definition
---

### Проект
Проект (project) — это директория, содержащая приложение или набор приложений (см. [приложение](#приложение)).

* Приложение может находиться в корне проекта (в этом случае в корне проекта лежит соответствующий Dappfile).
* В случае, если в проекте есть несколько приложений — они находятся в директориях .dapps/\<имя-приложения\>/ (в каждой из которых есть соответствующий Dappfile).

### Директория проекта
Директория проекта (project dir) — это директория, содержащая директорию .dapps или, при отсутствии .dapps, это директория, содержащая Dappfile.

### Имя проекта
Имя проекта — это последний элемент пути к git репозиторию из параметра конфигурации remote.origin.url или, при отсутствии git или параметра конфигурации remote.origin.url, это имя [директории проекта](#директория-проекта).

### Dappfile
Dappfile — это файл, содержащий инструкции по сборке docker образов приложения (см. [приложение](#приложение)).

### Приложение
Приложение (dapp) — это набор правил, объединенных в одном Dappfile, по которым происходит сборка одного или нескольких подприложений.

* В рамках одного приложения может быть описано дерево подприложений.
* При сборке дерева подприложений, docker образы будут собраны для всех подприложений листьев описанного дерева.

### Директория приложения
Директория приложения (home dir) — это директория, содержащая [Dappfile](#dappfile) [приложения](#приложение).

### Базовое имя приложения
Базовое имя приложения (basename) ­— это имя, связанное с каждым Dappfile.

* По умолчанию базовое имя приложения ­— это имя директории, в которой находится Dappfile.
* Базовое имя приложения может быть переопределено в Dappfile (см. [name](base_directives.html#name-<name>)).

### Подприложение
Подприложение (app) — это средство группировки правил сборки в иерархию с наследованием.

* Подприложение наследует правила сборки того подприложения, в котором оно объявлено, и глобальные правила сборки.
* Сборка docker образов осуществляется только для тех подприложений, которые являются листьями в описанном дереве.
* Для каждого подприложения в Dappfile указывается имя.
  * При этом вложенные подприложения наследуют имена родительских подприложений и базовое имя приложения (см. [базовое имя приложения](#базовое-имя-приложения)).
  * Итоговое имя подприложения имеет вид: \<базовое имя приложения\>-\<подприложение-1\>-\<подприложение-2\>...-\<подприложение-N\>.
  
### Артефакт
Артефакт (artifact) — это несамостоятельное [приложение](#приложение).

* Используется для изолирования процесса сборки (среды, программного обеспечение, данных) необходимых ресурсов от связанных приложений.
* Наследования от родителя происходит по тем же правилам, что и у [подприложения](#подприложение).
* Стадии артефакта практически полностью совпадают со стадиями приложения, но:
  * Отсутствуют:
    * git_artifact_post_setup_patch.
    * git_artifact_latest_patch.
    * docker_instructions.
  * Добавляются:
    * git_artifact_artifact_patch.
    * build_artifact.
* Могут использоваться такие же директивы, как у приложения, но с некоторыми особенностями:
  * [docker](docker_directives.html): не используются директивы применения dockerfile-инструкций.
  * [shell](shell_directives.html): добавляется директива [build_artifact](shell_directives.html#shell-build_artifact-<cmd>-<cmd>-cache_version-<cache_version>).
  * У артефакта не может быть потомков, поэтому отсутствуют директивы app и artifact.

### Стадия
Стадия (stage) — это именованный набор инструкций для сборки docker образа.

* Собранное приложение представляет собой цепочку связанных стадий.
* Имя docker образа стадии формируется по шаблону: dappstage-\<[имя проекта](#имя-проекта)\>-\<[базовое имя приложения](#базовое-имя-приложения)\>:\<[сигнатура стадии](#сигнатура-стадии)\>.

### Сигнатура стадии
Сигнатура стадии (signature) — это контрольная сумма правил сборки, зависимостей стадии и сигнатуры предыдущей стадии, если она существует.

* Изменение сигнатуры стадии ведет к её пересборке, а также последующих стадий.
* При отсутствии правил и зависимостей, стадия игнорируется, используется сигнатура предыдущей стадии.

### Кэш приложения
Набор docker-образов, который определяется [стадиями приложения](#стадия).

### Тип сборки
Dapp поддерживает 2 типа сборки: [chef приложение](#chef-приложение) и [shell приложение](#shell-приложение).

* В одном [приложении](#приложение) может быть использован один тип сборки.
* Тип сборки определяется автоматически при первом использовании соответствующей инструкции в [Dappfile](#dappfile).

### Chef приложение
Chef приложение — это приложение, для сборки которого используются [cookbook приложения](#cookbook-приложения) и [mdapp модули](#mdapp-модуль).

### Cookbook приложения
Cookbook приложения (dapp cookbook) — это основной chef cookbook, связанный с одним [приложением](#приложение).

* Обязательные файлы:
  * metadata.rb
    * Содержит все зависимости, в т.ч. [mdapp модули](#mdapp-модуль).
  * Berksfile
    * Содержит все зависимости, в т.ч. [mdapp модули](#mdapp-модуль).
  * Berksfile.lock
    * Может отсутствовать в [dev режиме](#режим-разработки) — будет создан во время выполнения сборки.
* Структура файлов.
  * Атрибуты.
    * Файлы атрибутов не поддерживаются.
    * Хэш normal-атрибутов задается через [Dappfile](#dappfile), см. [chef.attribute](chef_directives.html#chef-attributes), [chef.\<стадия\>\_attribute](chef_directives.html#chef-<стадия>_attributes).
  * Файлы.
    * Директория files/\<стадия\>/\<рецепт\> — содержит файлы рецепта для стадии, опциональна.
    * Директория files/\<стадия\>/common — содержит общие файлы для стадии, опциональна.
    * Недопустимо наличие одинаковых имен файлов в директории рецепта и common.
  * Шаблоны.
    * Директория templates/\<стадия\>/\<рецепт\> — содержит файлы шаблонов рецепта для стадии, опциональна.
    * Директория templates/\<стадия\>/common — содержит общие файлы шаблонов для стадии, опциональна.
    * Недопустимо наличие одинаковых имен файлов в директории рецепта и common.
  * Рецепты.
    * Директория recipes/\<стадия\> — содержит файлы рецептов для стадии, опциональна.

### Mdapp модуль
Mdapp модуль — это дополнительный chef cookbook, который подключается к сборке [chef приложения](#chef-приложение).

* Обязательные файлы:
  * metadata.rb
* Структура файлов.
  * Файлы атрибутов не поддерживаются.
  * Файлы.
    * Директория files/\<стадия\> — содержит файлы доступные для стадии, опциональна.
    * Директория files/common — содержит файлы доступные для всех стадий, опциональна.
    * Недопустимо наличие одинаковых имен файлов в директории стадии и common.
  * Шаблоны.
    * Директория template/\<стадия\> — содержит файлы доступные для стадии, опциональна.
    * Директория template/common — содержит файлы доступные для всех стадий, опциональна.
    * Недопустимо наличие одинаковых имен файлов в директории стадии и common.
  * Рецепты.
    * Файл recipes/\<стадия\>.rb — файл рецепта модуля для стадии, опционален.

### Стадия cookbook\`а
Стадия cookbook\`а — это часть cookbook\`а, которая используется при сборке стадии для cookbook\`а приложения и mdapp модулей.

* Понятие применимо только к cookbook\`у приложения и mdapp модулям.
* Для всех остальных cookbook\`ов при сборке стадии используется все файлы cookbook\`а.

### Установка стадии cookbook\`а
Установка стадии cookbook\`а — это процесс копирования файлов стадии cookbook\`а во [временное хранилище](#временная-директория-приложения), подключаемое в дальнейшем в контейнер для сборки стадии.

* Установка [cookbook\`а приложения](#cookbook-приложения).
  * Атрибуты.
    * Хэш атрибутов, совмещенных из [chef.attribute](chef_directives.html#chef-attributes) и [chef.\<стадия\>\_attribute](chef_directives.html#chef-<стадия>_attributes), устанавливается в normal-атрибуты, передаваемые через JSON-файл.
    * Файлы атрибутов не поддерживаются.
  * Файлы.
    * Содержимое директории files/\<стадия\>/common при наличии устанавливается в директорию files/default.
    * Содержимое директории files/\<стадия\>/\<рецепт\> устанавливается в директорию files/default.
      * Для каждого включенного рецепта при наличии соответствующей директории.
    * Недопустимо наличие одинаковых имен файлов в директории рецепта и common.
  * Шаблоны.
    * Содержимое директории templates/\<стадия\>/common при наличии устанавливается в директорию templates/default.
    * Содержимое директории templates/\<стадия\>/\<рецепт\> устанавливается в директорию templates/default.
      * Для каждого включенного рецепта при наличии соответствующей директории.
    * Недопустимо наличие одинаковых имен файлов в директории рецепта и common.
  * Рецепты.
    * Файл recipes/\<стадия\>/\<рецепт\>.rb устанавливается в recipes/\<рецепт\>.rb.
      * Для каждого включенного рецепта при его наличии.
    * При отсутствии рецептов генерируется пустой рецепт recipes/void.rb.
      * Отсутствие рецептов подразумевает одно из условий:
        * отсутствие включенных рецептов в конфигурации;
        * отсутствие файлов рецептов (recipes/\<стадия\>/\<рецепт\>.rb) для всех включенных в конфигурации рецептов.
      * Это позволяет активировать атрибуты, объявленные в данном cookbook\`е.
* Установка [mdapp модуля](#mdapp-модуль).
  * Файлы атрибутов не поддерживаются.
  * Файлы.
    * Содержимое директории files/common при наличии устанавливается в директорию files/default.
    * Содержимое директории files/\<стадия\> при наличии устанавливается в директорию files/default.
    * Недопустимо наличие одинаковых имен файлов в директории стадии и common.
  * Шаблоны.
    * Содержимое директории templates/common при наличии устанавливается в директорию templates/default.
    * Содержимое директории templates/\<стадия\> при наличии устанавливается в директорию templates/default.
    * Недопустимо наличие одинаковых имен файлов в директории стадии и common.
  * Рецепты.
    * Файл recipes/\<стадия\>.rb при наличии устанавливается в recipes/\<стадия\>.rb.
    * При отсутствии рецепта генерируется пустой рецепт recipes/void.rb.
      * Это позволяет активировать атрибуты, объявленные в данном cookbook\`е, при отсутствии рецепта.
* Остальныe cookbook\`и устанавливаются без изменений, "как есть".

### Контрольная сумма cookbook\`ов стадии
Контрольная сумма cookbook\`ов стадии — это контрольная сумма всех [установленных файлов cookbook\`ов](#установка-стадии-cookbookа) для данной стадии.

### Дерево cookbooks
Дерево cookbooks — это результат выполнения berks vendor в chef приложении.

### Shell проект
Shell проект — это проект, для сборки которого используются команды bash, заданные в [Dappfile](#dappfile).

### Директория сборки проекта
Директория сборки проекта (build dir) — это директория для хранения кэша и производных данных сборки [проекта](#проект).

* Используется для:
  * Хранения [дерева cookbooks](#дерево-cookbooks).
    * Этот результат при возможности кэшируется между сборками.
  * Кэширования [контрольных сумм cookbook\`ов стадий](#контрольная-сумма-cookbookов-стадии).
  * Хранения файлов блокировок проекта.
* Путь к build директории.
  * По умолчанию: \<[директория проекта](#директория-проекта)\>/.dapps_build.
  * Переопределяется параметром --build-dir.
* Необходимо указывать одну и ту же build директорию для каждой из вызываемых команд dapp (или использовать путь к директории по умолчанию).
* При указании build директории необходимо иметь в виду, что для каждого [проекта](#проект) нужна отдельная директория.
* Одна и та же build директория используется всеми [приложениями](#приложение), описанными в данном [проекте](#проект).

### Временная директория приложения
Временная директория приложения (tmp dir) — это временная рабочая директория сборщика [приложения](#приложение).

* Создается для каждого [приложения](#приложение) во время сборки.
* Используется для хранения:
  * Склонированных remote git репозиториев.
  * [Стадий cookbook\`ов](#стадия-cookbookа), [установленных](#установка-стадии-cookbookа) для сборки стадии.
* Путь к директории: /tmp/dapp-\<date\>-\<random\>.
* Удаление директории происходит автоматически при ожидаемом успешном или неуспешном завершении работы dapp.

### Режим разработки
* Включается опцией командной строки --dev.
* Используется для:
  * включения создания файла Berksfile.lock в случае его отсутствия (см. [cookbook приложения](#cookbook-приложения)).

### Блокировка ресурса
Блокировки обеспечивают корректную работу команд dapp при их параллельном запуске в рамках одного проекта на одном сервере.

* Блокировки реализованы с использованием механизма файловых блокировок ОС.
* Файлы блокировок хранятся в директории \<[build dir](#директория-сборки)\>/locks.

### Внешняя директория сборки
Директория, которая монтируется в docker-контейнеры в процессе сборки [приложения](#приложение).

* Используется для уменьшения размера [кэша приложения](#кэш-приложения) и конечного образа приложения соответственно.
* Ожидается директория с данными порождаемыми в процессе сборки, которые:
  * не требуются конечному пользователю;
  * занимают значительный размер.
* Для добавления используются директивы [tmp_dir](base_directives.html#tmp_dir-<dir>-dir) и [build_dir](base_directives.html#build_dir-<dir>-dir), которые различаются местом размещения внешней директории. 

### Scratch образ
Пустой docker образ, используемый в качестве окружения приложения по умолчанию, если пользователь не указал его ([docker.from](docker_directives.html#docker-from-<image>-cache_version-<cache_version>)).

#### Генерация происходит следующим образом 
```bash
tar c --files-from /dev/null | docker import - dappdeps/scratch
```
