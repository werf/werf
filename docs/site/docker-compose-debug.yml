version: "3.9"

services:
  site:
    image: $WERF_WEB_BACKEND_DOCKER_IMAGE_NAME
    command: "dlv --listen=:2345 --headless=true --api-version=2 --accept-multiclient --log exec ./server"
    environment:
      WERF_LOG_VERBOSE: "on"
      LOG_LEVEL: "trace"
    cap_add:
      - ALL
    security_opt:
      - apparmor:unconfined
    ports:
      - "2345:2345"
    volumes:
      - ".helm/multiwerf-dev.json:/app/multiwerf/multiwerf.json:ro"
      - ".helm/trdl_channels-dev.yaml:/app/trdl/trdl_channels.yaml:ro"
  documentation-en:
    image: jekyll/jekyll:3
    working_dir: "/srv/jekyll-data/src/documentation"
    command: bash -c "
        mkdir -m 777 -p /srv/jekyll-data/_site/_en /srv/jekyll-data/src/documentation/.jekyll-cache &&
        jekyll serve --config _config.yml -d /srv/jekyll-data/_site/_en -P 4040 "
    volumes:
      - "../:/srv/jekyll-data/src/"
  documentation-ru:
    image: jekyll/jekyll:3
    working_dir: "/srv/jekyll-data/src/documentation"
    command: bash -c "
      mkdir -m 777 -p /srv/jekyll-data/_site/_ru /srv/jekyll-data/src/documentation/.jekyll-cache &&
      jekyll serve --config _config.yml,_config_ru.yml -d /srv/jekyll-data/_site/_ru  -P 4041 "
    volumes:
      - "../:/srv/jekyll-data/src/"
  front:
    image: nginx:latest
    volumes:
      - ".werf/nginx-dev.conf:/etc/nginx/nginx.conf:ro"
    ports:
      - "80:80"

  tuf:
    image: $WERF_TUF_ROUTER_DOCKER_IMAGE_NAME
    command: ["nginx", "-g", "daemon off;"]
