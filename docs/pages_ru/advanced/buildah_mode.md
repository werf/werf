---
title: Режим сборки с использованием Buildah
permalink: advanced/buildah_mode.html
---

В настоящее время werf поддерживает сборку образов с _использованием Docker-сервера_ или _без его использования_ (в экспериментальном режиме).  Эта страница содержит сведения, которые применимы только для экспериментального режима _без Docker-сервера_. На данный момент для этого типа сборки доступен только сборщик образов на основе Dockerfile'ов. Сборщик Stapel будет доступен через некоторое время.

В экспериментальном режиме _без Docker-сервера_ werf использует встроенный Buildah в rootless-режиме.

## Включение Buildah

Buildah включается установкой переменной окружения `WERF_BUILDAH_MODE` в один из вариантов: `auto`, `native-chroot`, `native-rootless` или `docker-with-fuse`.

* `auto` — автоматический выбор режима в зависимости от платформы и окружения;
* `native-chroot` работает только в Linux и использует `chroot`-изоляцию для сборочных контейнеров;
* `native-rootless` работает только в Linux и использует `rootless`-изоляцию для сборочных контейнеров. На этом уровне изоляции werf использует среду выполнения сборочных операций в контейнерах (runc или crun).
* `docker-with-fuse` — только этот кроссплатформенный режим доступен для MacOS или Windows.

Большинству пользователей для включения экспериментального режима Buildah достаточно установить `WERF_BUILDAH_MODE=auto`.

## Драйвер хранилища

werf может использовать драйвер хранилища `overlay` или `vfs`:

* `overlay` позволяет использовать файловую систему OverlayFS. Можно использовать либо встроенную в ядро Linux поддержку OverlayFS (если она доступна), либо реализацию fuse-overlayfs. Это рекомендуемый выбор по умолчанию.
* `vfs` обеспечивает доступ к виртуальной файловой системе вместо OverlayFS. Эта файловая система уступает по производительности и требует привилегированного контейнера, поэтому ее не рекомендуется использовать. Однако в некоторых случаях она может пригодиться.

Как правило, достаточно использовать драйвер по умолчанию (`overlay`). Драйвер хранилища можно задать с помощью переменной окружения `WERF_BUILDAH_STORAGE_DRIVER`.

### Системные требования

Rootless-файловая система OverlayFS доступна, начиная с ядра Linux версии 5.11 (строго говоря, с версии 5.13, которая содержит багфикс для включения rootless OverlayFS в SELinux, но большинство основных дистрибутивов Linux бэкпортировали его в ядро 5.11).

Если ваше ядро не поддерживает OverlayFS в режиме rootless, будет использоваться fuse-overlayfs.
