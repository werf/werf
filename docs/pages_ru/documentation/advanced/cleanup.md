---
title: Очистка
sidebar: documentation
permalink: documentation/advanced/cleanup.html
---

В процессе сборки и публикации образов приложений Docker-слои создаются, но никогда не удаляются. 
Как следствие, [хранилище стадий]({{ "documentation/internals/stages_and_storage.html#хранилище" | true_relative_url: page.url }}) и репозиторий образов в Docker registry постоянно увеличивается в размерах, требуя все больше и больше ресурсов.
Прерванная сборка образа также оставляет после себя образы, которые уже никогда не будут использоваться. 

Таким образом, необходимо периодически производить очистку от неиспользуемых образов как _хранилища стадий_, так и Docker registry.

В werf реализован эффективный многоуровневый алгоритм очистки образов, использующий следующие подходы:

1. [**Очистка по политикам**](#очистка-по-политикам)
1. [**Ручная очистка**](#ручная-очистка)
1. [**Очистка хоста**](#очистка-хоста)

## Очистка по политикам

Этот метод очистки рассчитан на периодический запуск по расписанию. 
Удаление производится в соответствии с принятыми политиками очистки и является безопасной процедурой, т.к. при его запуске используются блокировки, а также игнорируются используемые в кластере образы.

Очистка по политикам состоит из двух шагов и выполняется в следующем порядке:
1. [**Очистка образов**](#очистка-образов) очищает Docker registry от неактуальных образов в соответствии с политиками очистки.
2. [**Очистка хранилища стадий**](#очистка-хранилища-стадий) синхронизирует состояние _хранилища стадий_ с существующими образами в Docker registry.

Оба указанных способа очистки объединены в команде [werf cleanup]({{ "documentation/reference/cli/werf_cleanup.html" | true_relative_url: page.url }}), при которой сначала выполняется удаление неактуальных образов проекта, а затем синхронизация хранилища стадий.

Docker registry является главным источником информации об образах, поэтому в первую очередь выполняется очистка образов, а уже потом _хранилища стадий_.

### Очистка образов 

#### Алгоритм работы очистки по истории git

Результатом сборки является _конечный образ_, который может быть связан с произвольным количеством Docker-тегов. _Конечный образ_ связан с внутренним идентификатором werf, [дайджестом стадий образа]({{ "documentation/internals/stages_and_storage.html#дайджест-стадии" | true_relative_url: page.url }}).

В основу алгоритма очистки ложится тот факт, что в [хранилище стадий]({{ "documentation/internals/stages_and_storage.html#хранилище" | true_relative_url: page.url }}) сохраняется информация о коммитах, на которых выполнялась публикация тегов (добавился, изменился или нет образ в Docker registry — не имеет значения), связанных с определённым [дайджестом стадий образа]({{ "documentation/internals/stages_and_storage.html#дайджест-стадии" | true_relative_url: page.url }}): связка коммит и _дайджест стадий образа_ для конкретного `image` из `werf.yaml`.

В результате сборки и публикации очередного коммита, _конечный образ_ может не измениться, тем не менее в хранилище стадий добавится запись с информацией о том, что публикация [дайджеста стадий образа]({{ "documentation/internals/stages_and_storage.html#дайджест-стадии" | true_relative_url: page.url }}) была вызвана на определённом коммите.

Таким образом, обеспечивается связь [дайджеста стадий образа]({{ "documentation/internals/stages_and_storage.html#дайджест-стадии" | true_relative_url: page.url }}) (произвольного количества связанных Docker-тегов) с историей git и появляется возможность организации эффективной очистки неактуальных образов на основе состояния git и [выбранных политик](#пользовательские-политики). Алгоритм сканирует историю git,  отбирает значимые образы и удаляет образы, которые не попали ни под одну политику, при этом [теги используемые в Kubernetes](#игнорирование-используемых-в-кластере-kubernetes-образов) игнорируются.

Рассмотрим основные шаги алгоритма очистки:

- [Получение необходимых для очистки данных из хранилища стадий](#используемые-при-очистке-данные-хранилища-стадий):
    - все когда-либо собираемые [имена образов]({{ "documentation/reference/werf_yaml.html#секция-image" | true_relative_url: page.url }});
    - набор связок [дайджест стадий образа]({{ "documentation/internals/stages_and_storage.html#дайджест-стадии" | true_relative_url: page.url }}) и коммит, на котором выполнялась публикация.
- Получение манифестов для всех тегов.
- Подготовка набора для очистки:
    - [используемые в Kubernetes теги](#игнорирование-используемых-в-кластере-kubernetes-образов) игнорируются.
- Подготовка данных для сканирования:
    - сгруппированные теги по дайджесту стадий образа __(1)__;
    - cгруппированные коммиты по дайджесту стадий образа __(2)__;
    - набор git-тегов и git-веток, а также правила и глубина обхода, по которым должно выполняться сканирование каждого reference, исходя из [пользовательских политик](#пользовательские-политики) __(3)__. 
- Поиск коммитов __(2)__ по истории git __(3)__. В результате получаются [дайджесты стадий образа]({{ "documentation/internals/stages_and_storage.html#дайджест-стадии" | true_relative_url: page.url }}), для которых не было найдено связанных коммитов при сканировании __(4)__.
- Удаление тегов __(1)__ для [дайджестов стадий образа]({{ "documentation/internals/stages_and_storage.html#дайджест-стадии" | true_relative_url: page.url }}) __(4)__.

##### Пользовательские политики

Используя [политики очистки]({{ "documentation/advanced/cleanup.html" | true_relative_url: page.url }}), `keepPolicies`, пользователь определяет образы, которые не должны удаляться при очистке. При отсутствии конфигурации в `werf.yaml` будет использован [набор политик по умолчанию]({{ "documentation/reference/werf_yaml.html#политики-по-умолчанию" | true_relative_url: page.url }}).

Стоит отметить, что алгоритм сканирует локальное состояние git репозитория и актуальность git-веток и git-тегов крайне важна. Для синхронизации состояния git можно воспользоваться опцией `--git-history-synchronization`, которая по умолчанию включена при запуске в CI системах.

##### Используемые при очистке данные хранилища стадий   

Для оптимизации и решения специфичных кейсов, werf при работе сохраняет дополнительные данные в [хранилище стадий]({{ "documentation/internals/stages_and_storage.html#хранилище" | true_relative_url: page.url }}). Среди таких данных мета-образы, хранящие связку [дайджеста стадий образа]({{ "documentation/internals/stages_and_storage.html#дайджест-стадии" | true_relative_url: page.url }}) и коммита, на котором выполнялась публикация, а также [имена образов]({{ "documentation/reference/werf_yaml.html#секция-image" | true_relative_url: page.url }}), которые когда-либо собирались.

Информация о коммитах является единственным источником правды при работе алгоритма и werf удаляет теги без подобной информации.

При организации автоматической очистки команда `werf cleanup` выполняется либо по расписанию, либо вручную по случаю. Чтобы избежать удаления рабочего кеша при добавлении/удалении образов в `werf.yaml` в соседних git-ветках, при сборке в [хранилище стадий]({{ "documentation/internals/stages_and_storage.html#хранилище" | true_relative_url: page.url }}) добавляется имя собираемого образа. Используя набор команд `werf managed-images ls|add|rm`, пользователь может редактировать, так называемый набор _managed images_.

#### Игнорирование используемых в кластере Kubernetes образов

Пока в кластере Kubernetes существует объект использующий образ, он никогда не удалится из Docker registry. Другими словами, если что-то было запущено в вашем кластере Kubernetes, то используемые образы ни при каких условиях не будут удалены при очистке.

При запуске очистки werf сканирует следующие типы объектов в кластере Kubernetes: `pod`, `deployment`, `replicaset`, `statefulset`, `daemonset`, `job`, `cronjob`, `replicationcontroller`.

Описанное поведение, — проверка объектов в кластере при очистке, может быть отключено параметром `--without-kube`.

##### Подключение к кластеру Kubernetes

werf получает информацию о кластерах Kubernetes и способах подключения к ним из файла конфигурации kubectl — `~/.kube/config`. Для сбора информации об используемых объектами образах, werf подключается **ко всем кластерам** Kubernetes, описанным **во всех контекстах** конфигурации kubectl.

### Очистка хранилища стадий

Выполнение очистки хранилища стадий с помощью команды werf stages cleanup необходимо, чтобы синхронизировать его состояние с состоянием Docker registry.

Выполняя эту операцию, werf удаляет _стадии_, которые не связаны ни с одним образом в Docker registry.

> Если первый этап очистки по политикам, выполнение команды werf images cleanup, был пропущен, то выполнение команды werf stages cleanup не даст никакого эффекта

## Ручная очистка

Ручная очистка подразумевает полное удаление образов из _хранилища стадий_ или Docker registry (в зависимости от команды). Ручная очистка не учитывает, используется образ в кластере Kubernetes или нет.

Ручная очистка не подразумевает использования для запуска по расписанию. Она предназначена преимущественно для ручного удаления всех образов проекта.

Выполнение ручной очистки возможно следующими способами:
* Команда werf images purge. Удаляет все образы **текущего проекта** в Docker registry.
* Команда werf stages purge. Удаляет все стадии **текущего проекта** в [хранилище стадий]({{ "documentation/internals/stages_and_storage.html#хранилище" | true_relative_url: page.url }}).

Оба способа ручной очистки объединены в команде [werf purge]({{ "documentation/reference/cli/werf_purge.html" | true_relative_url: page.url }}), при которой сначала выполняется удаление образов проекта из Docker registry (_werf images purge_), а затем, удаление образов из _хранилища стадий_ _werf stages purge_).

## Очистка хоста

Для очистки хоста, на котором используется werf, предназначены следующие команды:

* [werf host cleanup]({{ "documentation/reference/cli/werf_cleanup.html" | true_relative_url: page.url }}). Очищает старые, неиспользуемые и неактуальные данные, включая кэш стадий во всех проектах на хосте.
* [werf host purge]({{ "documentation/reference/cli/werf_purge.html" | true_relative_url: page.url }}). Удаляет образы, стадии, кэш и другие данные (служебные папки, временные файлы), относящиеся к любому проекту werf на хосте. Другими словами, удаляет все следы werf для всех проектов. Эта команда обеспечивает максимальную степень очистки. Используйте её, например, если не планируете больше использовать werf на данном хосте.
