.test_integration_per_k8s_version:
  variables:
    WERF_TEST_K8S_DOCKER_REGISTRY_INSECURE: "false"
  script:
    - |
      task --yes test:setup:environment
      export KUBECONFIG="$CI_PROJECT_DIR/werf.kubeconfig-${CI_JOB_ID}"
      export WERF_TEST_K8S_DOCKER_REGISTRY="localhost:$(docker inspect kind-registry-${CI_JOB_ID} --format '{{(index (index .NetworkSettings.Ports "5000/tcp") 0).HostPort}}')"
      task --yes -p test:integration $paths kubeVersion=${KUBE_VERSION} paths="integration/suites/cleanup_after_converge integration/suites/deploy integration/suites/helm/deploy_rollback" -- --keep-going
  after_script:
    - TASK_X_REMOTE_TASKFILES=1 task --yes test:cleanup:environment