.test_e2e_per_k8s_version:
  variables:
    WERF_TEST_K8S_DOCKER_REGISTRY_INSECURE: "false"
    SCOPE: ""
    PACKAGES: ""
    EXCLUDE_PACKAGES: ""
  script:
    - |
      task --yes test:setup:environment
      export KUBECONFIG="$CI_PROJECT_DIR/werf.kubeconfig-${CI_JOB_ID}"
      export WERF_TEST_K8S_DOCKER_REGISTRY="localhost:$(docker inspect kind-registry-${CI_JOB_ID} --format '{{(index (index .NetworkSettings.Ports "5000/tcp") 0).HostPort}}')"
      test -n ${PACKAGES} && paths=paths="$(echo ${PACKAGES} | tr , ' ')"
      task --yes -p test:e2e:${SCOPE} $paths kubeVersion=${KUBE_VERSION} -- --keep-going --skip-package "$EXCLUDE_PACKAGES"
  after_script:
    - TASK_X_REMOTE_TASKFILES=1 task --yes test:cleanup:environment